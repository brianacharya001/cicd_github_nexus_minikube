name: Install Nexus on Minikube (Self-Hosted)

on:
  workflow_dispatch:

jobs:
  install-nexus:
    runs-on: self-hosted
    timeout-minutes: 50

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Minikube Connectivity
        shell: bash
        run: |
          set -euo pipefail
          kubectl config use-context minikube
          kubectl cluster-info
          kubectl get nodes

      - name: Add Nexus Helm repo
        shell: bash
        run: |
          set -euo pipefail
          # Using the more modern and maintained chart repo
          helm repo add sonatype https://sonatype.github.io/helm3-charts/
          helm repo update

      - name: Create namespace
        shell: bash
        run: |
          set -euo pipefail
          kubectl create namespace nexus --dry-run=client -o yaml | kubectl apply -f -

      - name: Pre-clean failed installation
        shell: bash
        run: |
          # If a previous attempt timed out, Helm might see it as "pending-install"
          # This clears the state so the next command can run cleanly.
          helm uninstall nexus -n nexus || true

      - name: Install/Upgrade Nexus
        shell: bash
        run: |
          set -euo pipefail

          # Increased timeout to 35m and adjusted resources for stability
          helm upgrade --install nexus sonatype/nexus-repository-manager \
            --namespace nexus \
            --set nexus.service.type=NodePort \
            --set persistence.enabled=true \
            --set persistence.storageClass=standard \
            --set persistence.storageSize=10Gi \
            --set nexusProxy.enabled=false \
            --set resources.requests.cpu=500m \
            --set resources.requests.memory=2Gi \
            --set resources.limits.cpu=1 \
            --set resources.limits.memory=4Gi \
            --wait \
            --timeout 35m

      - name: Print Nexus Connection Info
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Deployment Status ==="
          kubectl get pods -n nexus
          
          echo "=== Access URL ==="
          minikube service nexus-sonatype-nexus -n nexus --url || echo "Could not generate URL automatically."

      - name: Get initial admin password
        shell: bash
        run: |
          set -euo pipefail
          # Wait a few extra seconds for the filesystem to settle
          sleep 20
          POD=$(kubectl get pods -n nexus -l app.kubernetes.io/instance=nexus -o jsonpath='{.items[0].metadata.name}')
          
          echo "Nexus Pod: ${POD}"
          echo "Initial admin password:"
          kubectl exec -n nexus "${POD}" -- cat /nexus-data/admin.password || echo "Password file not found yet. It may take a minute for Nexus to generate it on first boot."

      - name: Debug Nexus if install fails
        if: failure()
        shell: bash
        run: |
          set +e
          echo "=== Events ==="
          kubectl get events -n nexus --sort-by=.lastTimestamp | tail -50
          echo "=== Pod Description ==="
          kubectl describe pods -n nexus
          echo "=== Logs ==="
          kubectl logs -n nexus -l app.kubernetes.io/instance=nexus --tail=100
