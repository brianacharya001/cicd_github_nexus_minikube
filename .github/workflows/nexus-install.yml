name: Install Nexus on Minikube (Self-Hosted)

on:
  workflow_dispatch:

jobs:
  install-nexus:
    runs-on: self-hosted
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Minikube Connectivity
        shell: bash
        run: |
          set -euo pipefail

          echo "Switching to Minikube context..."
          kubectl config use-context minikube

          echo "Checking cluster status..."
          kubectl cluster-info

          echo "Nodes:"
          kubectl get nodes -o wide

          echo "StorageClasses:"
          kubectl get sc || true

      - name: Ensure Helm is available
        shell: bash
        run: |
          set -euo pipefail
          helm version

      - name: Add Nexus Helm repo
        shell: bash
        run: |
          set -euo pipefail
          helm repo add oteemocharts https://oteemo.github.io/charts
          helm repo update

      - name: Create namespace
        shell: bash
        run: |
          set -euo pipefail
          kubectl create namespace nexus --dry-run=client -o yaml | kubectl apply -f -

      - name: Install/Upgrade Nexus (more resilient)
        shell: bash
        run: |
          set -euo pipefail

          # Nexus first install can take a long time (image pull + init + persistence)
          helm upgrade --install nexus oteemocharts/sonatype-nexus \
            --namespace nexus \
            --create-namespace \
            --set nexus.service.type=NodePort \
            --set persistence.enabled=true \
            --set persistence.storageClassName=standard \
            --set persistence.storageSize=8Gi \
            --set resources.requests.cpu=200m \
            --set resources.requests.memory=1Gi \
            --set resources.limits.cpu=1 \
            --set resources.limits.memory=2Gi \
            --wait \
            --timeout 25m

          echo "=== Post-install status ==="
          kubectl get pods -n nexus -o wide
          kubectl get pvc -n nexus
          kubectl get svc -n nexus

      - name: Print Nexus URL (Minikube service)
        shell: bash
        run: |
          set -euo pipefail

          echo "Nexus URL (try minikube service):"
          minikube service nexus-sonatype-nexus -n nexus --url || true

          echo ""
          echo "If the service name differs, run:"
          echo "  kubectl get svc -n nexus"
          echo "  minikube service <service-name> -n nexus --url"

      - name: Get initial admin password
        shell: bash
        run: |
          set -euo pipefail

          # This label works for many installs, but if it doesn't, we fallback to first pod
          POD="$(kubectl get pods -n nexus -l app=sonatype-nexus -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)"
          if [[ -z "${POD}" ]]; then
            POD="$(kubectl get pods -n nexus -o jsonpath='{.items[0].metadata.name}')"
          fi

          echo "Nexus Pod: ${POD}"
          echo "Initial admin password:"
          kubectl exec -n nexus "${POD}" -- cat /nexus-data/admin.password || true

      - name: Debug Nexus if install fails
        if: failure()
        shell: bash
        run: |
          set +e

          echo "=== Pods ==="
          kubectl get pods -n nexus -o wide

          echo "=== PVC ==="
          kubectl get pvc -n nexus

          echo "=== Services ==="
          kubectl get svc -n nexus

          echo "=== Events (last 100) ==="
          kubectl get events -n nexus --sort-by=.lastTimestamp | tail -100

          echo "=== Describe pods ==="
          for p in $(kubectl get pods -n nexus -o name); do
            echo "--- $p ---"
            kubectl describe -n nexus "$p"
          done

          echo "=== Logs (best effort) ==="
          for p in $(kubectl get pods -n nexus -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- logs: $p ---"
            kubectl logs -n nexus "$p" --tail=200 || true
          done
